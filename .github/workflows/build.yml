name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Create Gradle Wrapper if missing
      run: |
        # Create directory structure
        mkdir -p gradle/wrapper
        
        # Create gradle-wrapper.properties
        cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-8.5-bin.zip
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        EOF
        
        # Create simplified gradlew script
        cat > gradlew << 'EOF'
        #!/usr/bin/env bash
        set -e
        SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
        JAR_PATH="$SCRIPT_DIR/gradle/wrapper/gradle-wrapper.jar"
        
        if [ ! -f "$JAR_PATH" ]; then
            echo "Downloading gradle-wrapper.jar..."
            mkdir -p "$(dirname "$JAR_PATH")"
            curl -L -o "$JAR_PATH" "https://github.com/gradle/gradle/raw/master/gradle/wrapper/gradle-wrapper.jar" || \
            wget -O "$JAR_PATH" "https://github.com/gradle/gradle/raw/master/gradle/wrapper/gradle-wrapper.jar"
        fi
        
        JAVA_OPTS="${JAVA_OPTS:--Xmx64m -Xms64m}"
        exec java $JAVA_OPTS -jar "$JAR_PATH" "$@"
        EOF
        
        # Create gradlew.bat for Windows
        cat > gradlew.bat << 'EOF'
        @echo off
        set DIRNAME=%~dp0
        if "%DIRNAME%" == "" set DIRNAME=.
        set APP_HOME=%DIRNAME%
        java -jar "%APP_HOME%\gradle\wrapper\gradle-wrapper.jar" %*
        EOF
        
        # Make gradlew executable
        chmod +x gradlew
        
    - name: Create Android project structure
      run: |
        # Create app directory if it doesn't exist
        mkdir -p app/src/main/java/com/personal/autobackup
        mkdir -p app/src/main/res
        
        # Create settings.gradle if missing
        if [ ! -f settings.gradle ]; then
          echo "include ':app'" > settings.gradle
        fi
        
        # Create root build.gradle if missing
        if [ ! -f build.gradle ]; then
          cat > build.gradle << 'EOF'
          buildscript {
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.2.0'
              }
          }
          
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          
          task clean(type: Delete) {
              delete rootProject.buildDir
          }
          EOF
        fi
        
        # Create app build.gradle if missing
        if [ ! -f app/build.gradle ]; then
          mkdir -p app
          cat > app/build.gradle << 'EOF'
          plugins {
              id 'com.android.application'
              id 'org.jetbrains.kotlin.android'
          }
          
          android {
              namespace 'com.personal.autobackup'
              compileSdk 34
              
              defaultConfig {
                  applicationId "com.personal.autobackup"
                  minSdk 21
                  targetSdk 34
                  versionCode 1
                  versionName "1.0.0"
              }
              
              buildTypes {
                  release {
                      minifyEnabled false
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }
              
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
              
              kotlinOptions {
                  jvmTarget = '17'
              }
          }
          
          dependencies {
              implementation 'androidx.core:core-ktx:1.12.0'
              implementation 'androidx.appcompat:appcompat:1.6.1'
              implementation 'com.google.android.material:material:1.10.0'
              implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
          }
          EOF
        fi
        
    - name: Download gradle-wrapper.jar
      run: |
        if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "ðŸ“¥ Downloading gradle-wrapper.jar..."
            mkdir -p gradle/wrapper
            wget -q -O gradle/wrapper/gradle-wrapper.jar \
                https://github.com/gradle/gradle/raw/master/gradle/wrapper/gradle-wrapper.jar
        fi
        
    - name: Build Debug APK
      run: |
        echo "ðŸ”¨ Building Debug APK..."
        ./gradlew assembleDebug --no-daemon --stacktrace
        
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: AutoBackupPro-Debug
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 7
